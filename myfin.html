<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Financial KPIs (Gains x Losses)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f5;
      color: #222;
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }
    .card {
      background: #fff;
      padding: 1rem 1.2rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .file-input {
      display: inline-block;
      margin-top: .5rem;
    }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .kpi {
      padding: 0.75rem;
      border-radius: 6px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
    }
    .kpi-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: .03em;
      opacity: 0.7;
      margin-bottom: 0.2rem;
    }
    .kpi-value {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .kpi-positive { color: #1b7e39; }
    .kpi-negative { color: #b3261e; }
    .kpi-neutral { color: #1f2a33; }

    .error {
      color: #b3261e;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #e0e0e0;
      text-align: right;
      white-space: nowrap;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    th {
      background: #f0f0f0;
      font-weight: 600;
    }

    .tables-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .hint {
      font-size: 0.85rem;
      color: #555;
      margin-top: 0.4rem;
    }
    .link-button {
      border: none;
      background: none;
      padding: 0;
      font: inherit;
      color: #1a73e8;
      cursor: pointer;
    }
    .link-button:hover {
      text-decoration: underline;
    }
    tr.is-filtered {
      background: #e8f0fe;
    }
    .table-empty {
      text-align: center;
      font-style: italic;
      color: #666;
    }
    .trend-icon {
      margin-left: 0.35rem;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }
    .trend-up {
      color: #1a73e8;
    }
    .trend-down {
      color: #d93025;
    }
    .hierarchy-table table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    .hierarchy-table th,
    .hierarchy-table td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #e0e0e0;
      text-align: right;
      white-space: nowrap;
    }
    .hierarchy-table th:first-child,
    .hierarchy-table td:first-child {
      text-align: left;
    }
    .hierarchy-row.year-row {
      background: #f3f4f6;
      font-weight: 600;
    }
    .hierarchy-row.month-row {
      background: #fafafa;
    }
    .hierarchy-row .level-label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .tree-toggle {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.1rem;
      display: inline-flex;
      align-items: center;
    }
    .tree-toggle:focus-visible {
      outline: 2px solid #1a73e8;
    }
    .level-label .indent {
      display: inline-block;
      width: 1rem;
    }
  </style>
  <!-- SheetJS (XLSX) CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Financial KPIs from XLSX</h1>

  <div class="card">
    <p><strong>Step 1:</strong> Load the published Google Sheets data.</p>
    <p class="hint">
      The sheet should contain the columns <code>Date</code>, <code>Single</code>, <code>IRA</code>, and <code>Trust Acct</code> in the first row.
      <br />
      The app uses public proxies so you can open it directly on mobile (no local server required).
      <br />
      If the online fetch fails, upload the <code>.xlsx</code> or <code>.csv</code> file below.
    </p>
    <button id="refreshBtn" class="link-button" style="font-size:1rem;">↻ Refresh from Google Sheets</button>
    <div>
      <label class="hint" for="fileInput">or choose a local file:</label>
      <input class="file-input" type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
    </div>
    <div id="error" class="error"></div>
    <details style="margin-top:0.6rem;">
      <summary>Debug log</summary>
      <pre id="debugLog" style="background:#111;color:#eee;padding:0.5rem;border-radius:6px;max-height:200px;overflow:auto;margin:0.4rem 0 0 0;"></pre>
    </details>
  </div>

  <div class="card">
    <h2>Overall Summary</h2>
    <div class="kpi-grid">
      <div class="kpi">
        <div class="kpi-title">Total Gained</div>
        <div id="totalGain" class="kpi-value kpi-positive">$0.00</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Total Lost</div>
        <div id="totalLoss" class="kpi-value kpi-negative">$0.00</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Net Result</div>
        <div id="netResult" class="kpi-value kpi-neutral">$0.00</div>
      </div>
      <div class="kpi">
        <div class="kpi-title"># of Entries</div>
        <div id="countTx" class="kpi-value kpi-neutral">0</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Balances by Investment</h2>
    <p class="hint">Latest entry for each type and the variation versus the previous record.</p>
    <div id="investmentGrid" class="kpi-grid">
      <div class="kpi">
        <div class="kpi-title">Awaiting file</div>
        <div class="kpi-value kpi-neutral">--</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Totals by Year / Month / Week / Day</h2>
    <p class="hint">Expand rows to drill down through the timeline.</p>
    <div class="hierarchy-table">
      <table>
        <thead>
          <tr>
            <th>Period</th>
            <th>Single</th>
            <th>IRA</th>
            <th>Trust Acct</th>
            <th>Total</th>
            <th>Diff</th>
          </tr>
        </thead>
        <tbody id="hierarchyBody">
          <tr>
            <td colspan="6" class="table-empty">Awaiting data...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>


  <div class="card">
    <h2>Detailed Entries</h2>
    <table id="snapshotsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Single</th>
          <th>IRA</th>
          <th>Trust Acct</th>
          <th>Total</th>
          <th>Diff</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const errorDiv = document.getElementById('error');
    const refreshBtn = document.getElementById('refreshBtn');
    const debugLogEl = document.getElementById('debugLog');
    const hierarchyBody = document.getElementById('hierarchyBody');
    const SHEET_URLS = [
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3AvzjoSaklTNllWooFtOT8TWNA0LA_L_-5eRGvYSbGnNgO2E4qLCNJwUtlY77u-ZNyuSyYsGi6T0x/pub?gid=0&single=true&output=csv',
      'https://cors.isomorphic-git.org/https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3AvzjoSaklTNllWooFtOT8TWNA0LA_L_-5eRGvYSbGnNgO2E4qLCNJwUtlY77u-ZNyuSyYsGi6T0x/pub?gid=0&single=true&output=csv',
      'https://r.jina.ai/https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3AvzjoSaklTNllWooFtOT8TWNA0LA_L_-5eRGvYSbGnNgO2E4qLCNJwUtlY77u-ZNyuSyYsGi6T0x/pub?gid=0&single=true&output=csv'
    ];
    const SHEET_GVIZ_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3AvzjoSaklTNllWooFtOT8TWNA0LA_L_-5eRGvYSbGnNgO2E4qLCNJwUtlY77u-ZNyuSyYsGi6T0x/gviz/tq?gid=0&headers=1';
    const investmentDefinitions = [
      { key: 'single', labels: ['single'], display: 'Single' },
      { key: 'ira', labels: ['ira'], display: 'IRA' },
      { key: 'trust', labels: ['trust acct', 'trust account', 'trust'], display: 'Trust Acct' }
    ];
    let hierarchyData = [];
    const expandedYears = new Set();
    const expandedMonths = new Set();
    const expandedWeeks = new Set();

    refreshBtn?.addEventListener('click', loadGoogleSheet);
    fileInput?.addEventListener('change', handleLocalFile);
    hierarchyBody?.addEventListener('click', handleHierarchyClick);
    loadGoogleSheet();

    async function loadGoogleSheet() {
      clearDebug();
      logDebug('Loading data from Google Sheets (CSV + JSONP fallback)...');
      showError('Loading data from Google Sheets...');
      try {
        const rows = await loadRowsFromPublishedSheet();
        logDebug(`Received ${rows.length - 1} rows from online sheet.`);
        processRows(rows);
        showError('');
      } catch (err) {
        console.error(err);
        showError(`Failed to load Google Sheets data. ${err.message || ''}`);
      }
    }

    async function loadRowsFromPublishedSheet() {
      let csvErrors = null;
      try {
        const csvText = await fetchSheetCSV();
        if (csvText) {
          logDebug('CSV fetch succeeded, parsing...');
          return convertCSVToRows(csvText);
        }
      } catch (err) {
        csvErrors = err;
        logDebug(`CSV fetch failed: ${err.message || err}`);
      }
      const jsonpRows = await loadRowsViaJSONP();
      if (jsonpRows && jsonpRows.length) {
        if (csvErrors) {
          console.warn('CSV fetch failed, using JSONP fallback:', csvErrors);
        }
        return jsonpRows;
      }
      throw csvErrors || new Error('Unable to fetch spreadsheet data.');
    }

    async function fetchSheetCSV() {
      const errors = [];
      for (const url of SHEET_URLS) {
        try {
            logDebug(`Trying CSV URL: ${url}`);
            const response = await fetch(url, { mode: 'cors' });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const text = await response.text();
            if (!text.trim()) throw new Error('Empty response');
            logDebug(`Success from CSV URL: ${url} (bytes=${text.length})`);
            return text;
        } catch (err) {
            errors.push(`${url}: ${err.message || err}`);
            logDebug(`Failed CSV URL: ${url} -> ${err.message || err}`);
        }
      }
      throw new Error(`CSV attempts failed. Details: ${errors.join(' | ')}`);
    }

    function convertCSVToRows(csvText) {
      const sanitized = csvText.replace(/^\uFEFF/, '');
      const delimiter = detectDelimiter(sanitized);
      const parsed = simpleCSVParse(sanitized, delimiter);
      if (parsed.length) {
        logDebug(`CSV parsed with delimiter "${delimiter}". Rows: ${parsed.length - 1}`);
        return parsed;
      }
      const workbook = XLSX.read(csvText, { type: 'string', raw: true });
      const firstSheetName = workbook.SheetNames[0];
      const ws = workbook.Sheets[firstSheetName];
      logDebug('CSV parser empty, falling back to SheetJS parse.');
      return XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
    }

    function detectDelimiter(text) {
      const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
      if (!lines.length) return ',';
      const sample = lines[0];
      const commaCount = (sample.match(/,/g) || []).length;
      const semicolonCount = (sample.match(/;/g) || []).length;
      const tabCount = (sample.match(/\t/g) || []).length;
      let delimiter = ',';
      let max = commaCount;
      if (semicolonCount > max) {
        delimiter = ';';
        max = semicolonCount;
      }
      if (tabCount > max) {
        delimiter = '\t';
      }
      return delimiter;
    }

    function simpleCSVParse(text, delimiter) {
      const rows = [];
      let current = [];
      let value = '';
      let insideQuotes = false;

      const pushValue = () => {
        current.push(value);
        value = '';
      };

      const pushRow = () => {
        if (current.length || value) {
          // ensures last value added before pushing row
          rows.push(current.slice());
        }
        current = [];
      };

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '"') {
          if (insideQuotes && text[i + 1] === '"') {
            value += '"';
            i++;
          } else {
            insideQuotes = !insideQuotes;
          }
        } else if (char === delimiter && !insideQuotes) {
          pushValue();
        } else if ((char === '\n' || char === '\r') && !insideQuotes) {
          if (char === '\r' && text[i + 1] === '\n') i++;
          pushValue();
          pushRow();
        } else {
          value += char;
        }
      }
      if (value.length || current.length) {
        pushValue();
        pushRow();
      }

      return rows.filter(row => row.some(cell => cell !== ''));
    }

    function loadRowsViaJSONP() {
      logDebug('Falling back to JSONP endpoint...');
      return new Promise((resolve, reject) => {
        const callbackName = `sheetCallback_${Date.now()}`;
        const script = document.createElement('script');
        const cleanup = () => {
          if (script.parentNode) script.parentNode.removeChild(script);
          delete window[callbackName];
        };

        window[callbackName] = (response) => {
          cleanup();
          try {
            const rows = convertGvizResponseToRows(response);
            logDebug(`JSONP returned ${rows.length} rows.`);
            resolve(rows);
          } catch (err) {
            logDebug(`JSONP parsing error: ${err.message || err}`);
            reject(err);
          }
        };

        script.onerror = () => {
          cleanup();
          logDebug('JSONP script failed to load.');
          reject(new Error('JSONP request failed.'));
        };

        const tqx = encodeURIComponent(`out:json;responseHandler=${callbackName};reqId=${Date.now()}`);
        script.src = `${SHEET_GVIZ_URL}&tq=&tqx=${tqx}`;
        script.async = true;
        document.body.appendChild(script);
      });
    }

    function convertGvizResponseToRows(response) {
      if (!response || response.status !== 'ok' || !response.table) {
        throw new Error('Unexpected JSONP response.');
      }
      const headers = response.table.cols.map(col => (col?.label || col?.id || '').trim());
      const rows = [headers];
      for (const row of response.table.rows) {
        if (!row || !row.c) continue;
        const cells = [];
        for (let i = 0; i < headers.length; i++) {
          const cell = row.c[i];
          if (!cell) {
            cells.push('');
          } else if (cell.f != null) {
            cells.push(cell.f);
          } else if (cell.v != null) {
            cells.push(cell.v);
          } else {
            cells.push('');
          }
        }
        rows.push(cells);
      }
      return rows;
    }

    function handleLocalFile(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const isCSV = /\.csv$/i.test(file.name);
      showError(`Loading local ${isCSV ? 'CSV' : 'Excel'} file...`);
      logDebug(`Loading local file: ${file.name} (${file.size} bytes)`); 

      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = evt.target?.result;
          if (!data) throw new Error('Unable to read file data.');
          let workbook;
          if (isCSV) {
            workbook = XLSX.read(data, { type: 'string', raw: true });
          } else {
            workbook = XLSX.read(data, { type: 'array', raw: true });
          }
          const firstSheetName = workbook.SheetNames[0];
          const ws = workbook.Sheets[firstSheetName];
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
          logDebug(`Local file parsed with ${rows.length - 1} data rows.`);
          processRows(rows);
          showError('');
        } catch (err) {
          console.error(err);
          showError(`Failed to read local file. ${err.message || ''}`);
        } finally {
          event.target.value = '';
        }
      };
      reader.onerror = function(err) {
        console.error(err);
        showError('Failed to read local file.');
        event.target.value = '';
      };
      if (isCSV) {
        reader.readAsText(file);
      } else {
        reader.readAsArrayBuffer(file);
      }
    }

    function processRows(rows) {
      if (!rows.length) {
        showError('Empty spreadsheet.');
        return;
      }

      const headerRowIndex = findHeaderRowIndex(rows);
      if (headerRowIndex === -1) {
        logDebug(`Could not locate header row. First row sample: ${JSON.stringify(rows[0])}`);
        showError('Could not find the header row with "Date".');
        return;
      }

      const headers = rows[headerRowIndex].map(h => String(h || '').trim());
      const normalizedHeaders = headers.map(normalizeHeader);
      const dateIdx = findHeaderIndex(normalizedHeaders, ['date', 'data']);

      if (dateIdx === -1) {
        logDebug(`Header row content: ${JSON.stringify(headers)}`);
        showError('Could not find the "Date" column on the first row.');
        return;
      }

      const dataRows = rows.slice(headerRowIndex + 1);
      logDebug(`Processing ${dataRows.length} data rows with ${headers.length} columns (header at index ${headerRowIndex}).`);

      const detectedInvestments = investmentDefinitions
        .map(def => {
          const idx = findHeaderIndex(normalizedHeaders, def.labels);
          if (idx === -1) return null;
          return {
            ...def,
            idx,
            display: headers[idx] || def.display
          };
        })
        .filter(Boolean);

      if (!detectedInvestments.length) {
        showError('Could not find the investment columns (Single, IRA, Trust Acct).');
        return;
      }

      const records = [];
      for (let i = 0; i < dataRows.length; i++) {
        const row = dataRows[i];
        if (!row || row.length === 0) continue;

        const rawDate = row[dateIdx];
        if (rawDate == null || rawDate === '') continue;
        const date = parseExcelDate(rawDate);
        if (!date) continue;

        const record = { date };
        let hasValue = false;

        for (const col of detectedInvestments) {
          const val = toNumber(row[col.idx]);
          record[col.key] = val;
          if (Number.isFinite(val)) {
            hasValue = true;
          }
        }

        if (!hasValue) continue;

        records.push(record);
      }

      if (!records.length) {
        showError('No valid rows found (invalid date/value).');
        return;
      }
      logDebug(`Built ${records.length} normalized records.`);

      records.sort((a, b) => a.date - b.date);
      let previousTotal = null;
      for (const rec of records) {
        const computedTotal = detectedInvestments.reduce((sum, col) => {
          const val = rec[col.key];
          return sum + (Number.isFinite(val) ? val : 0);
        }, 0);
        rec.total = computedTotal;
        if (previousTotal == null) {
          rec.diff = 0;
        } else {
          rec.diff = computedTotal - previousTotal;
        }
        previousTotal = computedTotal;
      }

      const movements = records.map(rec => ({
        date: rec.date,
        amount: Number.isFinite(rec.diff) ? rec.diff : 0
      }));

      calcularKPIs(movements, records.length);
      atualizarInvestimentos(records, detectedInvestments);
      preencherSnapshots(records, detectedInvestments);
      expandedYears.clear();
      expandedMonths.clear();
      expandedWeeks.clear();
      hierarchyData = buildHierarchy(records);
      renderHierarchy();
    }

    function showError(msg) {
      if (msg) console.error('[Finance Dashboard]', msg);
      errorDiv.textContent = msg;
      if (msg) logDebug(`ERROR: ${msg}`);
    }

    function logDebug(message) {
      if (!debugLogEl) return;
      const timestamp = new Date().toISOString();
      debugLogEl.textContent += `[${timestamp}] ${message}\n`;
    }

    function clearDebug() {
      if (debugLogEl) debugLogEl.textContent = '';
    }

    function parseExcelDate(val) {
      if (val instanceof Date) {
        return val;
      }
      if (typeof val === 'string') {
        const trimmed = val.trim();
        if (!trimmed) return null;
        const tryNative = new Date(trimmed);
        if (!isNaN(tryNative.getTime())) {
          return tryNative;
        }
        const numericCandidate = Number(trimmed.replace(',', '.'));
        if (Number.isFinite(numericCandidate)) {
          val = numericCandidate;
        } else {
          return null;
        }
      }
      if (typeof val === 'number') {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const date = new Date(excelEpoch.getTime() + val * 86400000);
        if (isNaN(date.getTime())) return null;
        return date;
      }
      return null;
    }

    function normalizeHeader(header) {
      return String(header || '').trim().toLowerCase().replace(/\s+/g, ' ');
    }

    function findHeaderRowIndex(rows) {
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row.length) continue;
        const normalized = row.map(normalizeHeader);
        if (findHeaderIndex(normalized, ['date', 'data']) !== -1) {
          return i;
        }
      }
      return -1;
    }

    function findHeaderIndex(headers, targets) {
      if (!Array.isArray(headers)) return -1;
      for (let i = 0; i < headers.length; i++) {
        if (targets.includes(headers[i])) {
          return i;
        }
      }
      return -1;
    }

    function toNumber(value) {
      if (value === null || value === undefined || value === '') return null;
      if (typeof value === 'number') {
        return Number.isFinite(value) ? value : null;
      }
      let normalized = String(value).trim();
      if (!normalized) return null;
      let negative = false;
      if (/^\(.*\)$/.test(normalized)) {
        negative = true;
        normalized = normalized.slice(1, -1);
      }
      normalized = normalized.replace(/\s+/g, '');
      normalized = normalized.replace(/,/g, '');
      const num = Number(normalized);
      if (!Number.isFinite(num)) return null;
      return negative ? -num : num;
    }

    function calcularKPIs(records, totalSnapshots) {
      let totalGain = 0;
      let totalLoss = 0;
      let net = 0;

      for (const r of records) {
        const amount = r.amount;
        net += amount;
        if (amount > 0) totalGain += amount;
        if (amount < 0) totalLoss += amount;
      }

      document.getElementById('totalGain').textContent = formatUSD(totalGain);
      document.getElementById('totalLoss').textContent = formatUSD(totalLoss);
      document.getElementById('netResult').textContent = formatUSD(net);
      document.getElementById('countTx').textContent = totalSnapshots.toString();
    }

    function getISOWeekKey(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
      const year = d.getUTCFullYear();
      return `${year}-W${String(weekNo).padStart(2, '0')}`;
    }

    function getISOWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    }

    function getMonthKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    function formatMonthKey(key) {
      const [y, m] = key.split('-');
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const idx = parseInt(m, 10) - 1;
      const labelMonth = monthNames[idx] || m;
      return `${labelMonth}/${y}`;
    }

    function formatUSD(value) {
      if (!Number.isFinite(value)) return '-';
      return value.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD'
      });
    }

    function atualizarInvestimentos(records, investments) {
      const grid = document.getElementById('investmentGrid');
      grid.innerHTML = '';

      if (!records.length) {
        grid.innerHTML = `
          <div class="kpi">
            <div class="kpi-title">No data</div>
            <div class="kpi-value kpi-neutral">--</div>
          </div>
        `;
        return;
      }

      const latest = records[records.length - 1];
      const fragment = document.createDocumentFragment();

      for (const col of investments) {
        const value = latest[col.key];
        if (!Number.isFinite(value)) continue;
        const card = document.createElement('div');
        card.className = 'kpi';
        card.innerHTML = `
          <div class="kpi-title">${col.display}</div>
          <div class="kpi-value kpi-neutral">${formatUSD(value)}</div>
        `;
        fragment.appendChild(card);
      }

      if (Number.isFinite(latest.total)) {
        const totalCard = document.createElement('div');
        totalCard.className = 'kpi';
        totalCard.innerHTML = `
          <div class="kpi-title">Consolidated total</div>
          <div class="kpi-value kpi-neutral">${formatUSD(latest.total)}</div>
        `;
        fragment.appendChild(totalCard);
      }

      const diffValue = Number.isFinite(latest.diff) ? latest.diff : 0;
      const diffClass = diffValue > 0 ? 'kpi-positive' : diffValue < 0 ? 'kpi-negative' : 'kpi-neutral';
      const diffCard = document.createElement('div');
      diffCard.className = 'kpi';
      diffCard.innerHTML = `
        <div class="kpi-title">Diff vs previous</div>
        <div class="kpi-value ${diffClass}">${formatUSD(diffValue)}</div>
      `;
      fragment.appendChild(diffCard);

      if (!fragment.childNodes.length) {
        grid.innerHTML = `
          <div class="kpi">
            <div class="kpi-title">No values</div>
            <div class="kpi-value kpi-neutral">--</div>
          </div>
        `;
      } else {
        grid.appendChild(fragment);
      }
    }

    function preencherSnapshots(records, investments) {
      const table = document.getElementById('snapshotsTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';

      if (!records.length) {
        thead.innerHTML = `
          <tr>
            <th>Date</th>
            <th>Total</th>
            <th>Diff</th>
          </tr>
        `;
        return;
      }

      const headers = ['Date', ...investments.map(col => col.display), 'Total', 'Diff'];
      thead.innerHTML = `<tr>${headers.map(title => `<th>${title}</th>`).join('')}</tr>`;

      const fragment = document.createDocumentFragment();
      let previousTotal = null;
      for (const record of records) {
        const tr = document.createElement('tr');
        const dateTd = document.createElement('td');
        dateTd.textContent = formatDateLabel(record.date);
        tr.appendChild(dateTd);

        for (const col of investments) {
          const td = document.createElement('td');
          td.textContent = formatUSD(record[col.key]);
          tr.appendChild(td);
        }

        const totalTd = document.createElement('td');
        totalTd.textContent = formatUSD(record.total);
        if (Number.isFinite(previousTotal) && Number.isFinite(record.total)) {
          if (record.total > previousTotal) {
            totalTd.innerHTML += ` <span class="trend-icon trend-up">&uarr;</span>`;
          } else if (record.total < previousTotal) {
            totalTd.innerHTML += ` <span class="trend-icon trend-down">&darr;</span>`;
          }
        }
        tr.appendChild(totalTd);

        const diffTd = document.createElement('td');
        diffTd.textContent = formatUSD(record.diff);
        diffTd.className = Number.isFinite(record.diff)
          ? (record.diff > 0 ? 'kpi-positive' : record.diff < 0 ? 'kpi-negative' : 'kpi-neutral')
          : '';
        tr.appendChild(diffTd);

        fragment.appendChild(tr);
        if (Number.isFinite(record.total)) {
          previousTotal = record.total;
        }
      }

      tbody.appendChild(fragment);
    }

    function formatDateLabel(date) {
      if (!(date instanceof Date) || isNaN(date.getTime())) return '-';
      return date.toLocaleDateString('en-US');
    }

    function buildHierarchy(records) {
      const yearMap = new Map();
      for (const rec of records) {
        const year = rec.date.getFullYear();
        const monthIndex = rec.date.getMonth();
        const dayLabel = rec.date.getDate().toString().padStart(2, '0');
        if (!yearMap.has(year)) {
          yearMap.set(year, {
            key: String(year),
            label: String(year),
            diff: 0,
            months: [],
            monthMap: new Map(),
            lastRecord: null
          });
        }
        const yearNode = yearMap.get(year);
        yearNode.diff += rec.diff;
        yearNode.lastRecord = rec;

        const monthKey = `${year}-${String(monthIndex + 1).padStart(2, '0')}`;
        if (!yearNode.monthMap.has(monthKey)) {
          yearNode.monthMap.set(monthKey, {
            key: monthKey,
            label: formatMonthKey(`${year}-${String(monthIndex + 1).padStart(2, '0')}`),
            diff: 0,
            days: [],
            lastRecord: null
          });
        }
          const monthNode = yearNode.monthMap.get(monthKey);
        monthNode.diff += rec.diff;
        monthNode.lastRecord = rec;
        if (!monthNode.weeks) {
          monthNode.weeks = new Map();
        }
        const weekKey = `${monthKey}-W${getISOWeekNumber(rec.date)}`;
        if (!monthNode.weeks.has(weekKey)) {
          monthNode.weeks.set(weekKey, {
            key: weekKey,
            label: `Week ${getISOWeekNumber(rec.date)}`,
            diff: 0,
            days: [],
            lastRecord: null
          });
        }
        const weekNode = monthNode.weeks.get(weekKey);
        weekNode.diff += rec.diff;
        weekNode.lastRecord = rec;
        weekNode.days.push({
          key: `${weekKey}-${dayLabel}`,
          label: `${dayLabel}/${String(monthIndex + 1).padStart(2, '0')}`,
          single: rec.single,
          ira: rec.ira,
          trust: rec.trust,
          total: rec.total,
          diff: rec.diff
        });
      }

      const years = [];
      for (const yearNode of yearMap.values()) {
        yearNode.months = Array.from(yearNode.monthMap.values()).sort((a, b) => (a.key > b.key ? 1 : -1));
        yearNode.single = yearNode.lastRecord?.single ?? 0;
        yearNode.ira = yearNode.lastRecord?.ira ?? 0;
        yearNode.trust = yearNode.lastRecord?.trust ?? 0;
        yearNode.total = yearNode.lastRecord?.total ?? 0;
        for (const month of yearNode.months) {
          const monthWeeks = Array.from(month.weeks.values()).sort((a, b) => (a.key > b.key ? 1 : -1));
          month.weekList = monthWeeks;
          month.single = month.lastRecord?.single ?? 0;
          month.ira = month.lastRecord?.ira ?? 0;
          month.trust = month.lastRecord?.trust ?? 0;
          month.total = month.lastRecord?.total ?? 0;
          for (const week of monthWeeks) {
            week.single = week.lastRecord?.single ?? 0;
            week.ira = week.lastRecord?.ira ?? 0;
            week.trust = week.lastRecord?.trust ?? 0;
            week.total = week.lastRecord?.total ?? 0;
          }
          delete month.weeks;
          delete month.lastRecord;
        }
        delete yearNode.monthMap;
        delete yearNode.lastRecord;
        delete yearNode.monthMap;
        delete yearNode.lastRecord;
        years.push(yearNode);
      }
      return years.sort((a, b) => b.key.localeCompare(a.key));
    }

    function renderHierarchy() {
      if (!hierarchyBody) return;
      hierarchyBody.innerHTML = '';
      if (!hierarchyData.length) {
        hierarchyBody.innerHTML = `<tr><td colspan="6" class="table-empty">No data</td></tr>`;
        return;
      }

      const fragment = document.createDocumentFragment();
      for (const year of hierarchyData) {
        const yearRow = document.createElement('tr');
        yearRow.className = 'hierarchy-row year-row';
        const expanded = expandedYears.has(year.key);
        yearRow.innerHTML = `
          <td>
            <div class="level-label">
              ${year.months.length ? `<button class="tree-toggle" data-year="${year.key}" aria-label="Toggle year">${expanded ? '▾' : '▸'}</button>` : '<span class="indent"></span>'}
              ${year.label}
            </div>
          </td>
          <td>${formatUSD(year.single)}</td>
          <td>${formatUSD(year.ira)}</td>
          <td>${formatUSD(year.trust)}</td>
          <td>${formatUSD(year.total)}</td>
          <td class="${year.diff > 0 ? 'kpi-positive' : year.diff < 0 ? 'kpi-negative' : 'kpi-neutral'}">${formatUSD(year.diff)}</td>
        `;
        fragment.appendChild(yearRow);

        if (expanded) {
          for (const month of year.months) {
            const monthRow = document.createElement('tr');
            monthRow.className = 'hierarchy-row month-row';
            const monthExpanded = expandedMonths.has(month.key);
            monthRow.innerHTML = `
              <td>
                <div class="level-label">
                  <span class="indent"></span>
                  ${month.weekList.length ? `<button class="tree-toggle" data-month="${month.key}" aria-label="Toggle month">${monthExpanded ? '▾' : '▸'}</button>` : '<span class="indent"></span>'}
                  ${month.label}
                </div>
              </td>
              <td>${formatUSD(month.single)}</td>
              <td>${formatUSD(month.ira)}</td>
              <td>${formatUSD(month.trust)}</td>
              <td>${formatUSD(month.total)}</td>
              <td class="${month.diff > 0 ? 'kpi-positive' : month.diff < 0 ? 'kpi-negative' : 'kpi-neutral'}">${formatUSD(month.diff)}</td>
            `;
            fragment.appendChild(monthRow);

            if (monthExpanded) {
              for (const week of month.weekList) {
                const weekRow = document.createElement('tr');
                weekRow.className = 'hierarchy-row';
                const weekExpanded = expandedWeeks.has(week.key);
                weekRow.innerHTML = `
                  <td>
                    <div class="level-label">
                      <span class="indent"></span>
                      <span class="indent"></span>
                      ${week.days.length ? `<button class="tree-toggle" data-week="${week.key}" aria-label="Toggle week">${weekExpanded ? '▾' : '▸'}</button>` : '<span class="indent"></span>'}
                      ${week.label}
                    </div>
                  </td>
                  <td>${formatUSD(week.single)}</td>
                  <td>${formatUSD(week.ira)}</td>
                  <td>${formatUSD(week.trust)}</td>
                  <td>${formatUSD(week.total)}</td>
                  <td class="${week.diff > 0 ? 'kpi-positive' : week.diff < 0 ? 'kpi-negative' : 'kpi-neutral'}">${formatUSD(week.diff)}</td>
                `;
                fragment.appendChild(weekRow);

                if (weekExpanded) {
                  for (const day of week.days) {
                    const dayRow = document.createElement('tr');
                    dayRow.className = 'hierarchy-row';
                    dayRow.innerHTML = `
                      <td>
                        <div class="level-label">
                          <span class="indent"></span>
                          <span class="indent"></span>
                          <span class="indent"></span>
                          ${day.label}
                        </div>
                      </td>
                      <td>${formatUSD(day.single)}</td>
                      <td>${formatUSD(day.ira)}</td>
                      <td>${formatUSD(day.trust)}</td>
                      <td>${formatUSD(day.total)}</td>
                      <td class="${day.diff > 0 ? 'kpi-positive' : day.diff < 0 ? 'kpi-negative' : 'kpi-neutral'}">${formatUSD(day.diff)}</td>
                    `;
                    fragment.appendChild(dayRow);
                  }
                }
              }
            }
          }
        }
      }

      hierarchyBody.appendChild(fragment);
    }

    function handleHierarchyClick(event) {
      const yearBtn = event.target.closest('[data-year]');
      if (yearBtn) {
        const key = yearBtn.getAttribute('data-year');
        if (expandedYears.has(key)) {
          expandedYears.delete(key);
        } else {
          expandedYears.add(key);
        }
        renderHierarchy();
        return;
      }

      const monthBtn = event.target.closest('[data-month]');
      if (monthBtn) {
        const key = monthBtn.getAttribute('data-month');
        if (expandedMonths.has(key)) {
          expandedMonths.delete(key);
        } else {
          expandedMonths.add(key);
        }
        renderHierarchy();
        return;
      }

      const weekBtn = event.target.closest('[data-week]');
      if (weekBtn) {
        const key = weekBtn.getAttribute('data-week');
        if (expandedWeeks.has(key)) {
          expandedWeeks.delete(key);
        } else {
          expandedWeeks.add(key);
        }
        renderHierarchy();
      }
    }
  </script>
</body>
</html>
